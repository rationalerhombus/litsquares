<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Litsquares | Daily Challenge</title>
    <style>
        :root {
            --bg: #fdf5e6; --text: #1a1a1a; --primary: #4a5d4a; --correct: #8fbc8f;
            --wrong: #e9967a; --cell-bg: #ffffff; --border: #2c2c2c; --modal-bg: rgba(0,0,0,0.9);
        }
        [data-theme="dark"] {
            --bg: #121212; --text: #e0e0e0; --cell-bg: #1e1e1e; --border: #555;
        }
        * { box-sizing: border-box; transition: background 0.2s; }
        body { 
            background-color: var(--bg); font-family: 'Inter', system-ui, -apple-system, serif; 
            display: flex; flex-direction: column; align-items: center; padding: 10px; 
            color: var(--text); margin: 0; min-height: 100vh;
        }
        header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid var(--border); margin-bottom: 10px; }
        h1 { font-size: 2rem; margin: 0; font-weight: 900; letter-spacing: -2px; }
        #status-bar { margin: 10px 0; font-size: 0.95rem; font-weight: 800; background: var(--cell-bg); padding: 8px 25px; border-radius: 30px; border: 2px solid var(--border); }
        .game-container { 
            display: grid; grid-template-columns: 0.8fr 1fr 1fr 1fr; grid-template-rows: 0.8fr 1fr 1fr 1fr; 
            gap: 6px; width: 96vw; max-width: 500px; aspect-ratio: 1 / 1;
        }
        .cell { 
            display: flex; align-items: center; justify-content: center; background-color: var(--cell-bg); 
            border-radius: 6px; padding: 4px; text-align: center; position: relative; border: 2px solid var(--border);
            font-size: clamp(0.6rem, 2.5vw, 0.85rem); line-height: 1.1; overflow: hidden;
        }
        .header { background: transparent; border: none; font-weight: 900; text-transform: uppercase; color: var(--primary); font-size: clamp(0.45rem, 1.8vw, 0.65rem); }
        input { width: 100%; height: 100%; border: none; outline: none; text-align: center; font-family: inherit; font-size: inherit; background: transparent; color: var(--text); }
        .correct { background-color: var(--correct) !important; color: white; font-weight: 700; animation: pop 0.3s ease; }
        .wrong { animation: shake 0.4s ease; background-color: var(--wrong) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .suggestions { position: absolute; top: 100%; left: 0; width: 180%; background: var(--cell-bg); border: 2px solid var(--border); z-index: 1000; display: none; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 150px; overflow-y: auto; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.7rem; text-align: left; }
        #modal-overlay { position: fixed; inset: 0; background: var(--modal-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; visibility: hidden; opacity: 0; }
        #modal-overlay.active { visibility: visible; opacity: 1; }
        .modal { background: var(--bg); padding: 30px; border-radius: 20px; max-width: 450px; width: 90%; }
        .close-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; cursor: pointer; font-weight: 900; margin-top: 20px; }
        footer { margin-top: auto; padding: 20px; font-size: 0.8rem; font-weight: 700; opacity: 0.8; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
    </style>
</head>
<body>

    <header>
        <button class="icon-btn" onclick="toggleInstructions()">‚ùì</button>
        <h1>litsquares</h1>
        <button class="icon-btn" onclick="toggleTheme()">üåì</button>
    </header>

    <div id="status-bar">Guesses: <span id="guess-count">9</span></div>
    <div class="game-container" id="grid"></div>
    <div style="margin-top: 20px;"><button id="share-btn" onclick="shareResult()" style="display:none; padding:15px 30px; border-radius:50px; background:var(--primary); color:white; border:none; font-weight:900; cursor:pointer;">SHARE GRID ‚ÜóÔ∏è</button></div>
    <footer id="daily-date"></footer>

    <div id="modal-overlay">
        <div class="modal">
            <h2 style="margin-top:0">How to Play</h2>
            <p>Fill the grid by matching the <b>Author</b> (row) and the <b>Category</b> (column).</p>
            <p>Today's categories are guaranteed to match all three authors on the board. No impossible squares!</p>
            <p>Resets every night at <b>9:00 PM PT</b>.</p>
            <button class="close-btn" onclick="toggleInstructions()">Start Playing</button>
        </div>
    </div>

    <script>
        const categories = [
            { label: "BookTok Viral", id: "booktok" }, { label: "Regency Era", id: "regency" },
            { label: "WWII Setting", id: "wwii" }, { label: "Psych Thriller", id: "thriller" },
            { label: "Award Winner", id: "award" }, { label: "Magical Realism", id: "magic" },
            { label: "Enemies to Lovers", id: "enemies" }, { label: "Grumpy x Sunshine", id: "grumpy" },
            { label: "Unhinged Lead", id: "unhinged" }, { label: "Dark Academia", id: "academia" },
            { label: "Family Drama", id: "family" }, { label: "Translated", id: "translated" },
            { label: "Gothic Vibes", id: "gothic" }, { label: "Non-Fiction", id: "nonfiction" },
            { label: "Romantasy", id: "romantasy" }, { label: "Mystery", id: "mystery" },
            { label: "Queer Lead", id: "queer" }, { label: "Small Town", id: "smalltown" },
            { label: "Screen Adaptation", id: "screen" }, { label: "Historical Mystery", id: "hist_mystery" },
            { label: "Mixed Media", id: "mixed_media" }, { label: "High Fantasy", id: "high_fantasy" },
            { label: "Literary Fiction", id: "lit_fic" }, { label: "Debut Novel", id: "debut" },
            { label: "Classic/Legacy", id: "classic" }
        ];

        const authors = [
            // Thrillers & Contemporary (Elizabeth)
            { name: "Freida McFadden", tags: ["thriller", "mystery", "unhinged", "booktok"] },
            { name: "Sally Rooney", tags: ["lit_fic", "screen", "award", "family", "unhinged"] },
            { name: "Emily Henry", tags: ["romance", "booktok", "smalltown", "enemies", "grumpy", "screen", "family"] },
            { name: "Taylor Jenkins Reid", tags: ["booktok", "family", "screen", "mixed_media", "lit_fic", "award"] },
            { name: "Gillian Flynn", tags: ["thriller", "unhinged", "mystery", "screen", "lit_fic"] },
            { name: "Ruth Ware", tags: ["thriller", "mystery", "gothic", "academia"] },
            { name: "Holly Jackson", tags: ["mystery", "mixed_media", "booktok", "thriller"] },
            
            // Regency & Romance (Jade Lee)
            { name: "Julia Quinn", tags: ["regency", "screen", "family", "enemies", "romance"] },
            { name: "Jade Lee", tags: ["regency", "enemies", "grumpy", "romantasy", "romance"] },
            { name: "Georgette Heyer", tags: ["regency", "classic", "enemies", "mystery"] },
            { name: "Ali Hazelwood", tags: ["academia", "booktok", "grumpy", "romance"] },
            { name: "Sarah J. Maas", tags: ["high_fantasy", "romantasy", "enemies", "booktok", "screen"] },
            
            // History & Classics (Megan Davitt)
            { name: "Kristin Hannah", tags: ["wwii", "family", "screen", "lit_fic", "smalltown", "award"] },
            { name: "Anthony Doerr", tags: ["wwii", "award", "lit_fic", "screen"] },
            { name: "Agatha Christie", tags: ["mystery", "classic", "hist_mystery", "screen", "award"] },
            { name: "Ocean Vuong", tags: ["queer", "award", "lit_fic", "debut", "nonfiction"] },
            { name: "Toni Morrison", tags: ["classic", "award", "lit_fic", "family", "magic"] },
            { name: "Kazuo Ishiguro", tags: ["award", "lit_fic", "magic", "translated", "screen"] },
            { name: "Han Kang", tags: ["translated", "award", "unhinged", "lit_fic"] },
            { name: "Donna Tartt", tags: ["academia", "mystery", "award", "lit_fic", "gothic"] },
            { name: "Min Jin Lee", tags: ["family", "lit_fic", "award", "debut"] },
            { name: "Madeline Miller", tags: ["magic", "high_fantasy", "award", "booktok", "queer"] },
            { name: "Gabrielle Zevin", tags: ["booktok", "mixed_media", "lit_fic", "award", "screen"] },
            { name: "R.F. Kuang", tags: ["academia", "high_fantasy", "award", "booktok", "thriller", "lit_fic"] },
            { name: "Ottessa Moshfegh", tags: ["unhinged", "lit_fic", "award", "gothic", "mystery"] },
            { name: "Abraham Verghese", tags: ["family", "lit_fic", "award", "debut"] },
            { name: "Susanna Clarke", tags: ["magic", "academia", "high_fantasy", "award"] },
            { name: "Alice Hoffman", tags: ["magic", "family", "lit_fic", "gothic"] }
            // ... (Expandable to 50+)
        ];

        function getPTDate() {
            const now = new Date();
            const ptDate = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            ptDate.setHours(ptDate.getHours() + 3); // 9PM PT rolls to Midnight
            return ptDate;
        }

        const gameDate = getPTDate();
        document.getElementById('daily-date').innerText = "Puzzle for " + gameDate.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });

        function seededRandom(seed) { var x = Math.sin(seed) * 10000; return x - Math.floor(x); }

        function generateGuaranteedGrid() {
            let seed = gameDate.getFullYear() * 10000 + (gameDate.getMonth() + 1) * 100 + gameDate.getDate();
            let attempts = 0;

            while(attempts < 2000) {
                // 1. CHOOSE 3 AUTHORS FIRST
                let rows = [...authors].sort(() => seededRandom(seed + attempts) - 0.5).slice(0, 3);
                
                // 2. FIND CATEGORIES THEY ALL SHARE
                let sharedTags = categories.filter(cat => 
                    rows.every(auth => auth.tags.includes(cat.id))
                );

                // 3. IF WE HAVE 3+ SHARED TAGS, WE HAVE A VALID GRID
                if (sharedTags.length >= 3) {
                    let cols = sharedTags.sort(() => seededRandom(seed + attempts + 1) - 0.5).slice(0, 3);
                    return { rows, cols };
                }
                attempts++;
            }
            // Fallback just in case
            return { rows: authors.slice(0,3), cols: categories.slice(0,3) };
        }

        const { rows, cols } = generateGuaranteedGrid();
        let guessesLeft = 9;
        let score = [[0,0,0],[0,0,0],[0,0,0]];

        const gridEl = document.getElementById('grid');
        let html = `<div class="cell header"></div>`;
        cols.forEach(c => html += `<div class="cell header">${c.label}</div>`);
        rows.forEach((r, rIdx) => {
            html += `<div class="cell header">${r.name}</div>`;
            cols.forEach((c, cIdx) => {
                html += `<div class="cell" data-row="${r.name}" data-col="${c.id}" data-ridx="${rIdx}" data-cidx="${cIdx}">
                            <input type="text" class="book-input" placeholder="?" autocomplete="off">
                            <div class="suggestions"></div>
                         </div>`;
            });
        });
        gridEl.innerHTML = html;

        document.querySelectorAll('.book-input').forEach(input => {
            input.addEventListener('input', debounce(async (e) => {
                const query = e.target.value;
                const box = e.target.nextElementSibling;
                if (query.length < 3) { box.style.display = 'none'; return; }
                const resp = await fetch(`https://openlibrary.org/search.json?title=${query}&limit=5`);
                const data = await resp.json();
                box.innerHTML = '';
                data.docs.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${book.title} (${book.first_publish_year || '?'})`;
                    div.onclick = () => {
                        const cell = input.parentElement;
                        const authorMatch = (book.author_name || []).some(a => a.toLowerCase().includes(cell.dataset.row.toLowerCase()));
                        const authorData = authors.find(a => a.name === cell.dataset.row);
                        const isCorrect = authorMatch && authorData.tags.includes(cell.dataset.col);
                        guessesLeft--;
                        document.getElementById('guess-count').innerText = guessesLeft;
                        box.style.display = 'none';
                        if (isCorrect) {
                            input.value = book.title; cell.classList.add('correct'); input.disabled = true;
                            score[cell.dataset.ridx][cell.dataset.cidx] = 1;
                        } else {
                            cell.classList.add('wrong');
                            setTimeout(() => { cell.classList.remove('wrong'); input.value = ""; }, 500);
                        }
                        if (guessesLeft === 0) endGame();
                    };
                    box.appendChild(div);
                });
                box.style.display = 'block';
            }, 400));
        });

        function endGame() { document.querySelectorAll('input').forEach(i => i.disabled = true); document.getElementById('share-btn').style.display = 'block'; }
        function shareResult() {
            let text = `Litsquares ${gameDate.toLocaleDateString()}\n`;
            score.forEach(r => text += r.map(c => c ? "üü©" : "‚¨ú").join("") + "\n");
            navigator.clipboard.writeText(text); alert("Results copied!");
        }
        function toggleTheme() { document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark"; }
        function toggleInstructions() { document.getElementById('modal-overlay').classList.toggle('active'); }
        function debounce(f, t) { let timer; return (...a) => { clearTimeout(timer); timer = setTimeout(() => f.apply(this, a), t); }; }
        if (!localStorage.getItem('ls_v5')) { toggleInstructions(); localStorage.setItem('ls_v5', 't'); }
    </script>
</body>
</html>
