<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Book Grid | Daily Challenge</title>
    <style>
        body { background-color: #fdf5e6; font-family: 'Georgia', serif; display: flex; flex-direction: column; align-items: center; padding-top: 30px; color: #003366; }
        #status-bar { margin-bottom: 20px; font-size: 1.5rem; font-weight: bold; }
        
        /* THE GRID FIX */
        .game-container { 
            display: grid; 
            grid-template-columns: 110px 150px 150px 150px; 
            grid-template-rows: 80px 150px 150px 150px; 
            border: 3px solid #003366; 
            background-color: #003366; /* This creates the dark lines */
            gap: 2px; /* This defines the thickness of the grid lines */
        }

        .cell { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: white; /* This makes the boxes white inside the blue grid */
            padding: 10px; 
            text-align: center; 
            font-weight: bold; 
            position: relative; 
            min-height: 50px;
        }

        .header { 
            background-color: #fdf5e6; /* Headers match the body cream color */
            font-size: 0.85rem; 
            text-transform: uppercase; 
        }

        input { width: 100%; height: 100%; border: none; outline: none; text-align: center; font-family: inherit; font-size: 1rem; background: transparent; }
        
        .correct { background-color: #d4edda !important; color: #155724; }
        .wrong { background-color: #f8d7da !important; color: #721c24; }
        
        .suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #003366; z-index: 10; display: none; max-height: 150px; overflow-y: auto; }
        .suggestion-item { padding: 5px; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid #eee; color: black; text-align: left; }
    </style>
</head>
<body>

    <h1>The Book Grid</h1>
    <div id="status-bar">Guesses Left: <span id="guess-count">9</span></div>
    <div class="game-container" id="grid"></div>

    <script>
        const authors = [
            { name: "Stephen King", tags: ["modern", "movie", "award"] },
            { name: "Jane Austen", tags: ["classic", "movie", "pre1950"] },
            { name: "George Orwell", tags: ["classic", "pre1950", "movie"] },
            { name: "Toni Morrison", tags: ["modern", "award"] },
            { name: "Agatha Christie", tags: ["classic", "movie", "pre1950"] },
            { name: "Haruki Murakami", tags: ["modern", "award"] },
            { name: "Charles Dickens", tags: ["classic", "pre1950", "movie"] },
            { name: "J.K. Rowling", tags: ["modern", "movie"] },
            { name: "Margaret Atwood", tags: ["modern", "movie", "award"] },
            { name: "Ernest Hemingway", tags: ["classic", "pre1950", "award"] }
        ];

        const columns = [
            { label: "Movie/TV", type: "movie", tagReq: "movie" },
            { label: "Pre-1950", type: "pre1950", tagReq: "pre1950" },
            { label: "Award Winner", type: "award", tagReq: "award" },
            { label: "Classic Era", type: "classic", tagReq: "classic" },
            { label: "Modern Era", type: "modern", tagReq: "modern" }
        ];

        function getDailySeed() {
            const now = new Date();
            const ptDate = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) - (8 * 3600000) + (3 * 3600000));
            return ptDate.getFullYear() * 10000 + (ptDate.getMonth() + 1) * 100 + ptDate.getDate();
        }

        function seededRandom(seed) {
            var x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function generateGame() {
            const seed = getDailySeed();
            let selectedCols = [...columns].sort(() => seededRandom(seed) - 0.5).slice(0, 3);
            let eligibleAuthors = authors.filter(a => selectedCols.some(c => a.tags.includes(c.tagReq)));
            let selectedRows = eligibleAuthors.sort(() => seededRandom(seed + 1) - 0.5).slice(0, 3);
            return { selectedRows, selectedCols };
        }

        const { selectedRows, selectedCols } = generateGame();
        const gridElement = document.getElementById('grid');
        
        let html = `<div class="cell header"></div>`;
        selectedCols.forEach(c => html += `<div class="cell header">${c.label}</div>`);
        selectedRows.forEach(r => {
            html += `<div class="cell header">${r.name}</div>`;
            selectedCols.forEach(c => {
                html += `<div class="cell" data-row="${r.name}" data-col="${c.type}">
                            <input type="text" class="book-input"><div class="suggestions"></div>
                         </div>`;
            });
        });
        gridElement.innerHTML = html;

        // Guessing and API logic
        let guessesLeft = 9;
        const guessDisplay = document.getElementById('guess-count');
        const inputs = document.querySelectorAll('.book-input');

        inputs.forEach(input => {
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                const suggestionBox = e.target.nextElementSibling;
                if (query.length < 3) { suggestionBox.style.display = 'none'; return; }
                const response = await fetch(`https://openlibrary.org/search.json?title=${query}&limit=5`);
                const data = await response.json();
                suggestionBox.innerHTML = '';
                data.docs.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${book.title} (${book.first_publish_year || '?'})`;
                    div.onclick = () => {
                        input.value = book.title;
                        input.setAttribute('data-yr', book.first_publish_year);
                        input.setAttribute('data-auth', book.author_name ? book.author_name.join(',') : '');
                        input.setAttribute('data-movie', book.id_imdb ? 'true' : 'false');
                        suggestionBox.style.display = 'none';
                    };
                    suggestionBox.appendChild(div);
                });
                suggestionBox.style.display = 'block';
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && guessesLeft > 0 && input.value !== "") {
                    const cell = input.parentElement;
                    const targetRow = cell.getAttribute('data-row');
                    const targetCol = cell.getAttribute('data-col');
                    const selAuth = input.getAttribute('data-auth') || "";
                    const selYr = parseInt(input.getAttribute('data-yr'));
                    const hasMovie = input.getAttribute('data-movie') === 'true';

                    let correct = false;
                    if (selAuth.includes(targetRow)) {
                        if (targetCol === 'movie' && hasMovie) correct = true;
                        if (targetCol === 'pre1950' && selYr < 1950) correct = true;
                        if (targetCol === 'award') correct = true; 
                        if (targetCol === 'classic' && selYr < 1970) correct = true;
                        if (targetCol === 'modern' && selYr >= 1970) correct = true;
                    }

                    guessesLeft--;
                    guessDisplay.innerText = guessesLeft;
                    if (correct) { cell.classList.add('correct'); input.disabled = true; }
                    else { cell.classList.add('wrong'); setTimeout(() => cell.classList.remove('wrong'), 1000); input.value = ""; }
                }
            });
        });
    </script>
</body>
</html>
