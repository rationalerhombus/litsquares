<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Litsquares | Daily Challenge</title>
    <style>
        :root {
            --bg: #fdf5e6;
            --text: #1a1a1a;
            --primary: #6b4e71;
            --correct: #8fbc8f;
            --wrong: #e9967a;
            --cell-bg: #ffffff;
            --border: #333;
            --modal-bg: rgba(0,0,0,0.7);
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --text: #fdf5e6;
            --cell-bg: #2d2d2d;
            --border: #555;
        }

        * { box-sizing: border-box; transition: background 0.3s ease; }
        
        body { 
            background-color: var(--bg); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; color: var(--text); margin: 0; 
            min-height: 100vh;
        }

        header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        h1 { font-size: 1.8rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        
        #status-bar { 
            margin: 15px 0; font-size: 0.9rem; font-weight: 600; 
            background: var(--cell-bg); padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* The Grid */
        .game-container { 
            display: grid; 
            grid-template-columns: 0.8fr 1fr 1fr 1fr; 
            grid-template-rows: 0.8fr 1fr 1fr 1fr; 
            gap: 6px; 
            width: 95vw; 
            max-width: 480px; 
            aspect-ratio: 1 / 1;
        }

        .cell { 
            display: flex; align-items: center; justify-content: center; 
            background-color: var(--cell-bg); border-radius: 8px;
            padding: 4px; text-align: center; position: relative; 
            border: 2px solid var(--border);
            font-size: clamp(0.7rem, 2.2vw, 0.85rem);
        }

        .header { 
            background-color: transparent; border: none;
            font-weight: 800; text-transform: uppercase; 
            color: var(--primary); font-size: clamp(0.55rem, 1.8vw, 0.7rem);
        }

        input { 
            width: 100%; height: 100%; border: none; outline: none; 
            text-align: center; font-family: inherit; font-size: inherit;
            background: transparent; color: var(--text);
        }

        /* Animations */
        .correct { background-color: var(--correct) !important; color: white; animation: pop 0.3s ease; }
        .wrong { animation: shake 0.4s ease; background-color: var(--wrong) !important; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        @keyframes pop {
            0% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Suggestion UI */
        .suggestions { 
            position: absolute; top: 100%; left: 0; width: 140%; 
            background: var(--cell-bg); border: 2px solid var(--border);
            z-index: 1000; display: none; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            max-height: 180px; overflow-y: auto;
        }
        .suggestion-item { 
            padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;
            font-size: 0.75rem; text-align: left; color: var(--text);
        }

        /* Instruction Modal */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); display: flex; align-items: center; justify-content: center;
            z-index: 2000; visibility: hidden; opacity: 0; transition: 0.3s;
        }
        #modal-overlay.active { visibility: visible; opacity: 1; }
        .modal {
            background: var(--bg); padding: 25px; border-radius: 15px;
            max-width: 400px; width: 90%; color: var(--text);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top: 0; }
        .modal p { line-height: 1.5; font-size: 0.9rem; }
        .close-btn { 
            background: var(--primary); color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold;
        }

        footer { margin-top: auto; padding: 20px 0; font-size: 0.8rem; opacity: 0.7; font-weight: 600; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
    </style>
</head>
<body data-theme="light">

    <header>
        <button class="icon-btn" onclick="toggleInstructions()">‚ùì</button>
        <h1>Litsquares</h1>
        <button class="icon-btn" onclick="toggleTheme()">üåì</button>
    </header>

    <div id="status-bar">Guesses Left: <span id="guess-count">9</span></div>

    <div class="game-container" id="grid"></div>

    <div style="margin-top: 20px;">
        <button id="share-btn" onclick="shareResult()" style="display:none; padding:10px 20px; border-radius:8px; background:var(--primary); color:white; border:none; font-weight:bold;">Share Score ‚ÜóÔ∏è</button>
    </div>

    <footer id="daily-date"></footer>

    <!-- INSTRUCTIONS MODAL -->
    <div id="modal-overlay">
        <div class="modal">
            <h2>How to Play</h2>
            <p>Fill the grid with books that match both the <b>Author</b> and the <b>Category</b>.</p>
            <p>‚Ä¢ <b>BookTok:</b> Authors viral on TikTok/Socials.<br>
               ‚Ä¢ <b>Romance/Spice:</b> Known for chemistry-heavy plots.<br>
               ‚Ä¢ <b>Angst:</b> Millennial dread or emotional heavy-hitters.</p>
            <p>You have <b>9 guesses</b> to complete the grid. Good luck!</p>
            <button class="close-btn" onclick="toggleInstructions()">Got it!</button>
        </div>
    </div>

    <script>
        const authors = [
            { name: "Emily Henry", can: ["booktok", "romance", "modern"] },
            { name: "Sarah J. Maas", can: ["booktok", "fantasy", "modern"] },
            { name: "Sally Rooney", can: ["angst", "award", "modern"] },
            { name: "Ottessa Moshfegh", can: ["angst", "modern"] },
            { name: "R.F. Kuang", can: ["fantasy", "award", "modern"] },
            { name: "Colleen Hoover", can: ["booktok", "romance", "modern"] },
            { name: "Ocean Vuong", can: ["award", "angst", "modern"] },
            { name: "Taylor Jenkins Reid", can: ["booktok", "modern"] },
            { name: "Madeline Miller", can: ["fantasy", "booktok", "modern"] }
        ];

        const columns = [
            { label: "BookTok Fave", id: "booktok" },
            { label: "Romance / Spice", id: "romance" },
            { label: "Fantasy / Romantasy", id: "fantasy" },
            { label: "Millennial Angst", id: "angst" },
            { label: "Award Winner", id: "award" }
        ];

        // Set Date
        const today = new Date();
        document.getElementById('daily-date').innerText = today.toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Toggle Functions
        function toggleTheme() {
            document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
        }
        function toggleInstructions() {
            document.getElementById('modal-overlay').classList.toggle('active');
        }

        // Auto-show instructions for new users
        if (!localStorage.getItem('visited')) {
            setTimeout(toggleInstructions, 500);
            localStorage.setItem('visited', 'true');
        }

        // Grid Generation (Seeded by Date)
        function getDailySeed() { return new Date().setHours(0,0,0,0); }
        function seededRandom(seed) {
            var x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function generateGrid() {
            let seed = getDailySeed();
            let selectedCols = [...columns].sort(() => seededRandom(seed) - 0.5).slice(0, 3);
            let selectedRows = [...authors].sort(() => seededRandom(seed + 1) - 0.5).slice(0, 3);
            return { selectedRows, selectedCols };
        }

        const { selectedRows, selectedCols } = generateGrid();
        const gridElement = document.getElementById('grid');
        let guessesLeft = 9;
        let scoreGrid = [ [0,0,0], [0,0,0], [0,0,0] ];

        // Build Grid HTML
        let html = `<div class="cell header"></div>`;
        selectedCols.forEach(c => html += `<div class="cell header">${c.label}</div>`);
        selectedRows.forEach((r, rIdx) => {
            html += `<div class="cell header">${r.name}</div>`;
            selectedCols.forEach((c, cIdx) => {
                html += `<div class="cell" data-row="${r.name}" data-col="${c.id}" data-ridx="${rIdx}" data-cidx="${cIdx}">
                            <input type="text" class="book-input" placeholder="?" autocomplete="off">
                            <div class="suggestions"></div>
                         </div>`;
            });
        });
        gridElement.innerHTML = html;

        // Input & Logic
        const inputs = document.querySelectorAll('.book-input');
        inputs.forEach(input => {
            input.addEventListener('input', debounce(async (e) => {
                const query = e.target.value;
                const box = e.target.nextElementSibling;
                if (query.length < 3) { box.style.display = 'none'; return; }
                const resp = await fetch(`https://openlibrary.org/search.json?title=${query}&limit=5`);
                const data = await resp.json();
                box.innerHTML = '';
                data.docs.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${book.title} (${book.first_publish_year || '?'})`;
                    div.onclick = () => validateGuess(input, book);
                    box.appendChild(div);
                });
                box.style.display = 'block';
            }, 300));
        });

        function validateGuess(input, book) {
            const cell = input.parentElement;
            cell.querySelector('.suggestions').style.display = 'none';
            const authorObj = authors.find(a => a.name === cell.dataset.row);
            const authorMatch = (book.author_name || []).some(a => a.toLowerCase().includes(cell.dataset.row.toLowerCase()));
            const isCorrect = authorMatch && authorObj.can.includes(cell.dataset.col);

            guessesLeft--;
            document.getElementById('guess-count').innerText = guessesLeft;

            if (isCorrect) {
                input.value = book.title;
                cell.classList.add('correct');
                input.disabled = true;
                scoreGrid[cell.dataset.ridx][cell.dataset.cidx] = 1;
            } else {
                cell.classList.add('wrong');
                setTimeout(() => cell.classList.remove('wrong'), 500);
                input.value = "";
            }
            if (guessesLeft === 0) endGame();
        }

        function endGame() {
            inputs.forEach(i => i.disabled = true);
            document.getElementById('share-btn').style.display = 'inline-block';
        }

        function shareResult() {
            let grid = "Litsquares Daily\n";
            scoreGrid.forEach(r => { grid += r.map(c => c ? "üü©" : "‚¨ú").join("") + "\n"; });
            navigator.clipboard.writeText(grid);
            alert("Score copied!");
        }

        function debounce(f, t) {
            let timer; return (...a) => { clearTimeout(timer); timer = setTimeout(() => f.apply(this, a), t); };
        }
    </script>
</body>
</html>
