<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Book Grid | Daily Challenge</title>
    <style>
        * { box-sizing: border-box; }
        body { background-color: #fdf5e6; font-family: 'Georgia', serif; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; color: #003366; margin: 0; overflow-x: hidden; }
        h1 { font-size: 1.8rem; margin-bottom: 10px; text-align: center; }
        #status-bar { margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; }
        .game-container { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; grid-template-rows: 65px 100px 100px 100px; background-color: #003366; border: 3px solid #003366; gap: 2px; width: 100%; max-width: 450px; margin: 0 auto; }
        .cell { display: flex; align-items: center; justify-content: center; background-color: white; padding: 4px; text-align: center; font-weight: bold; position: relative; word-wrap: break-word; }
        .header { background-color: #fdf5e6; font-size: 0.65rem; text-transform: uppercase; line-height: 1.2; padding: 2px; }
        input { width: 100%; height: 100%; border: none; outline: none; text-align: center; font-family: inherit; font-size: 0.8rem; background: transparent; }
        .correct { background-color: #d4edda !important; color: #155724; }
        .wrong { background-color: #f8d7da !important; }
        .suggestions { position: absolute; top: 0; left: 0; width: 100%; background: white; border: 1px solid #003366; z-index: 100; display: none; max-height: 110px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .suggestion-item { padding: 12px 8px; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid #eee; color: black; text-align: left; line-height: 1.3; }
        @media (min-width: 480px) { .game-container { grid-template-columns: 110px 140px 140px 140px; grid-template-rows: 80px 140px 140px 140px; } .header { font-size: 0.8rem; } input { font-size: 0.95rem; } h1 { font-size: 2.5rem; } }
    </style>
</head>
<body>

    <h1>The Book Grid</h1>
    <div id="status-bar">Guesses: <span id="guess-count">9</span> Left</div>
    <div class="game-container" id="grid"></div>

    <script>
        const authors = [
            { name: "Stephen King", can: ["movie", "award", "modern"] },
            { name: "Jane Austen", can: ["movie", "classic", "pre1950"] },
            { name: "George Orwell", can: ["movie", "classic", "pre1950", "award"] },
            { name: "Toni Morrison", can: ["modern", "award", "movie"] },
            { name: "Agatha Christie", can: ["movie", "classic", "pre1950"] },
            { name: "Charles Dickens", can: ["movie", "classic", "pre1950"] },
            { name: "Ernest Hemingway", can: ["classic", "pre1950", "award", "movie"] },
            { name: "J.K. Rowling", can: ["modern", "movie", "award"] },
            { name: "Margaret Atwood", can: ["modern", "movie", "award"] },
            { name: "Gabriel García Márquez", can: ["modern", "award", "movie"] },
            { name: "Harper Lee", can: ["classic", "movie", "award"] },
            { name: "John Steinbeck", can: ["classic", "pre1950", "award", "movie"] }
        ];

        const columns = [
            { label: "Movie/TV Adaptation", id: "movie" },
            { label: "Published Pre-1950", id: "pre1950" },
            { label: "Major Award Winner", id: "award" },
            { label: "Classic Era", id: "classic" },
            { label: "Modern Era", id: "modern" }
        ];

        function getDailySeed() {
            const now = new Date();
            const ptDate = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) - (8 * 3600000) + (3 * 3600000));
            return ptDate.getFullYear() * 10000 + (ptDate.getMonth() + 1) * 100 + ptDate.getDate();
        }

        function seededRandom(seed) {
            var x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function generateGuaranteedGrid() {
            let seed = getDailySeed();
            let attempts = 0;
            while (attempts < 100) {
                let selectedCols = [...columns].sort(() => seededRandom(seed + attempts) - 0.5).slice(0, 3);
                let validAuthors = authors.filter(auth => selectedCols.every(col => auth.can.includes(col.id)));
                if (validAuthors.length >= 3) {
                    let selectedRows = validAuthors.sort(() => seededRandom(seed + attempts + 1) - 0.5).slice(0, 3);
                    return { selectedRows, selectedCols };
                }
                attempts++;
            }
            return { selectedRows: authors.slice(0,3), selectedCols: columns.slice(0,3) };
        }

        const { selectedRows, selectedCols } = generateGuaranteedGrid();
        const gridElement = document.getElementById('grid');
        let html = `<div class="cell header"></div>`;
        selectedCols.forEach(c => html += `<div class="cell header">${c.label}</div>`);
        selectedRows.forEach(r => {
            html += `<div class="cell header">${r.name}</div>`;
            selectedCols.forEach(c => {
                html += `<div class="cell" data-row="${r.name}" data-col="${c.id}">
                            <input type="text" class="book-input" autocomplete="off" placeholder="...">
                            <div class="suggestions"></div>
                         </div>`;
            });
        });
        gridElement.innerHTML = html;

        let guessesLeft = 9;
        const guessDisplay = document.getElementById('guess-count');
        const inputs = document.querySelectorAll('.book-input');

        inputs.forEach(input => {
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                const suggestionBox = e.target.nextElementSibling;
                if (query.length < 3) { suggestionBox.style.display = 'none'; return; }
                
                try {
                    const response = await fetch(`https://openlibrary.org/search.json?title=${query}&limit=6`);
                    const data = await response.json();
                    suggestionBox.innerHTML = '';
                    data.docs.forEach(book => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        let displayTitle = book.title;
                        if (book.subtitle) displayTitle += `: ${book.subtitle}`;
                        div.innerText = displayTitle;
                        
                        // SUBMIT ON CLICK LOGIC
                        div.onclick = () => {
                            suggestionBox.style.display = 'none';
                            validateGuess(input, book);
                        };
                        suggestionBox.appendChild(div);
                    });
                    suggestionBox.style.display = 'block';
                } catch (e) { console.log("API Error"); }
            });
        });

        function validateGuess(input, bookData) {
            if (guessesLeft <= 0) return;

            const cell = input.parentElement;
            const targetRow = cell.getAttribute('data-row');
            const targetCol = cell.getAttribute('data-col');
            
            const selAuth = bookData.author_name ? bookData.author_name.join(',') : "";
            const selYr = parseInt(bookData.first_publish_year) || 9999;
            const hasMovie = bookData.id_imdb ? true : false;

            let isCorrect = false;

            // 1. Validate Author
            const authorMatch = selAuth.toLowerCase().includes(targetRow.toLowerCase());

            // 2. Validate Category
            if (authorMatch) {
                if (targetCol === 'movie' && hasMovie) isCorrect = true;
                if (targetCol === 'pre1950' && selYr < 1950) isCorrect = true;
                if (targetCol === 'award') isCorrect = true;
                if (targetCol === 'classic' && selYr < 1970) isCorrect = true;
                if (targetCol === 'modern' && selYr >= 1970) isCorrect = true;
            }

            // Update guesses
            guessesLeft--;
            guessDisplay.innerText = guessesLeft;

            if (isCorrect) {
                input.value = bookData.title;
                cell.classList.add('correct');
                input.disabled = true;
            } else {
                cell.classList.add('wrong');
                input.value = "WRONG"; // Temporary visual feedback
                setTimeout(() => {
                    cell.classList.remove('wrong');
                    input.value = "";
                }, 800);
            }

            if (guessesLeft === 0) {
                setTimeout(() => {
                    alert("Game Over! Next puzzle at 9 PM PT.");
                    inputs.forEach(i => i.disabled = true);
                }, 500);
            }
        }
    </script>
</body>
</html>
