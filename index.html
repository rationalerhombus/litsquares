<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Book Grid | Daily Challenge</title>
    <style>
        /* CSS: Layout and Mobile Responsiveness */
        body { 
            background-color: #fdf5e6; 
            font-family: 'Georgia', serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px 10px; 
            color: #003366; 
            margin: 0; 
        }
        h1 { font-size: 1.8rem; margin-bottom: 10px; }
        #status-bar { margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; }
        
        .game-container { 
            display: grid; 
            grid-template-columns: 80px 1fr 1fr 1fr; 
            grid-template-rows: 60px 100px 100px 100px; 
            border: 2px solid #003366; 
            background-color: #003366; 
            gap: 2px; 
            width: 100%;
            max-width: 500px;
        }

        .cell { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: white; 
            padding: 5px; 
            text-align: center; 
            font-weight: bold; 
            position: relative; 
        }

        .header { 
            background-color: #fdf5e6; 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            line-height: 1.1;
        }

        input { 
            width: 100%; 
            height: 100%; 
            border: none; 
            outline: none; 
            text-align: center; 
            font-family: inherit; 
            font-size: 0.8rem; 
            background: transparent;
        }
        
        .correct { background-color: #d4edda !important; color: #155724; }
        .wrong { background-color: #f8d7da !important; color: #721c24; }
        
        .suggestions { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            background: white; 
            border: 1px solid #003366; 
            z-index: 100; 
            display: none; 
            max-height: 100px; 
            overflow-y: auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .suggestion-item { padding: 8px 4px; cursor: pointer; font-size: 0.75rem; border-bottom: 1px solid #eee; color: black; text-align: left; }

        @media (min-width: 480px) {
            .game-container { grid-template-columns: 110px 150px 150px 150px; grid-template-rows: 80px 150px 150px 150px; }
            .header { font-size: 0.85rem; }
            input { font-size: 1rem; }
            h1 { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <h1>The Book Grid</h1>
    <div id="status-bar">Guesses: <span id="guess-count">9</span> Left</div>
    <div class="game-container" id="grid"></div>

    <script>
        // 1. DATA POOL 
        // "can" array defines which columns an author can successfully fulfill.
        const authors = [
            { name: "Stephen King", can: ["movie", "award", "modern"] },
            { name: "Jane Austen", can: ["movie", "classic", "pre1950"] },
            { name: "George Orwell", can: ["movie", "classic", "pre1950", "award"] },
            { name: "Toni Morrison", can: ["modern", "award", "movie"] },
            { name: "Agatha Christie", can: ["movie", "classic", "pre1950"] },
            { name: "Charles Dickens", can: ["movie", "classic", "pre1950"] },
            { name: "Ernest Hemingway", can: ["classic", "pre1950", "award", "movie"] },
            { name: "J.K. Rowling", can: ["modern", "movie", "award"] },
            { name: "Margaret Atwood", can: ["modern", "movie", "award"] },
            { name: "Gabriel García Márquez", can: ["modern", "award", "movie"] },
            { name: "Harper Lee", can: ["classic", "movie", "award"] },
            { name: "John Steinbeck", can: ["classic", "pre1950", "award", "movie"] }
        ];

        const columns = [
            { label: "Movie/TV", id: "movie" },
            { label: "Pre-1950", id: "pre1950" },
            { label: "Award Winner", id: "award" },
            { label: "Classic Era", id: "classic" },
            { label: "Modern Era", id: "modern" }
        ];

        // 2. DAILY SEED (Refreshes 9pm PT)
        function getDailySeed() {
            const now = new Date();
            const ptDate = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) - (8 * 3600000) + (3 * 3600000));
            return ptDate.getFullYear() * 10000 + (ptDate.getMonth() + 1) * 100 + ptDate.getDate();
        }

        function seededRandom(seed) {
            var x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // 3. GENERATOR (Guarantees every square is possible)
        function generateGuaranteedGrid() {
            let seed = getDailySeed();
            let attempts = 0;
            while (attempts < 100) {
                let selectedCols = [...columns].sort(() => seededRandom(seed + attempts) - 0.5).slice(0, 3);
                let validAuthors = authors.filter(auth => 
                    selectedCols.every(col => auth.can.includes(col.id))
                );
                if (validAuthors.length >= 3) {
                    let selectedRows = validAuthors.sort(() => seededRandom(seed + attempts + 1) - 0.5).slice(0, 3);
                    return { selectedRows, selectedCols };
                }
                attempts++;
            }
            return { selectedRows: authors.slice(0,3), selectedCols: columns.slice(0,3) };
        }

        const { selectedRows, selectedCols } = generateGuaranteedGrid();

        // 4. RENDER GRID
        const gridElement = document.getElementById('grid');
        let html = `<div class="cell header"></div>`;
        selectedCols.forEach(c => html += `<div class="cell header">${c.label}</div>`);
        selectedRows.forEach(r => {
            html += `<div class="cell header">${r.name}</div>`;
            selectedCols.forEach(c => {
                html += `<div class="cell" data-row="${r.name}" data-col="${c.id}">
                            <input type="text" class="book-input" autocomplete="off">
                            <div class="suggestions"></div>
                         </div>`;
            });
        });
        gridElement.innerHTML = html;

        // 5. GAME LOGIC
        let guessesLeft = 9;
        const guessDisplay = document.getElementById('guess-count');
        const inputs = document.querySelectorAll('.book-input');

        inputs.forEach(input => {
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                const suggestionBox = e.target.nextElementSibling;
                if (query.length < 3) { suggestionBox.style.display = 'none'; return; }
                
                try {
                    const response = await fetch(`https://openlibrary.org/search.json?title=${query}&limit=5`);
                    const data = await response.json();
                    suggestionBox.innerHTML = '';
                    data.docs.forEach(book => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = `${book.title} (${book.first_publish_year || '?'})`;
                        div.onclick = () => {
                            input.value = book.title;
                            input.setAttribute('data-yr', book.first_publish_year);
                            input.setAttribute('data-auth', book.author_name ? book.author_name.join(',') : '');
                            input.setAttribute('data-movie', book.id_imdb ? 'true' : 'false');
                            suggestionBox.style.display = 'none';
                        };
                        suggestionBox.appendChild(div);
                    });
                    suggestionBox.style.display = 'block';
                } catch (e) { console.log("API Error"); }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && guessesLeft > 0 && input.value !== "") {
                    const cell = input.parentElement;
                    const targetRow = cell.getAttribute('data-row');
                    const targetCol = cell.getAttribute('data-col');
                    const selAuth = input.getAttribute('data-auth') || "";
                    const selYr = parseInt(input.getAttribute('data-yr'));
                    const hasMovie = input.getAttribute('data-movie') === 'true';

                    let correct = false;
                    if (selAuth.toLowerCase().includes(targetRow.toLowerCase())) {
                        if (targetCol === 'movie' && hasMovie) correct = true;
                        if (targetCol === 'pre1950' && selYr < 1950) correct = true;
                        if (targetCol === 'award') correct = true; 
                        if (targetCol === 'classic' && selYr < 1970) correct = true;
                        if (targetCol === 'modern' && selYr >= 1970) correct = true;
                    }

                    guessesLeft--;
                    guessDisplay.innerText = guessesLeft;
                    if (correct) { 
                        cell.classList.add('correct'); 
                        input.disabled = true; 
                    } else { 
                        cell.classList.add('wrong'); 
                        setTimeout(() => cell.classList.remove('wrong'), 1000); 
                        input.value = ""; 
                    }
                    
                    if (guessesLeft === 0) {
                        alert("Game Over! Come back at 9 PM PT for a new grid.");
                        inputs.forEach(i => i.disabled = true);
                    }
                }
            });
        });
    </script>
</body>
</html>
